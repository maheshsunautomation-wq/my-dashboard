<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pie Chart</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body{
    background:#000;
    color:#fff;
    font-family:Arial, sans-serif;
    padding:18px;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  canvas{ background:#111; border-radius:12px; width:100px; max-width:60%; padding:12px; }
  .controls{ margin-top:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
  #thresholdBox{ background:#111; padding:12px; border-radius:12px; border:1px solid #333; color:#fff; min-width:360px; }
  #thresholdBox div{ display:flex; justify-content:space-between; margin:8px 0; }
  #thresholdBox input{ width:100px; background:#222; color:#fff; padding:6px; border-radius:6px; border:1px solid #666; }
  #saveBtn{ margin-top:8px; padding:8px 14px; background:#00aaff; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
  .sensor-option{ background:#111; padding:8px 12px; border-radius:8px; border:1px solid #333; display:inline-flex; gap:8px; align-items:center;}
  #statusPanel{ background:#111; padding:12px; border-radius:12px; min-width:360px; border:1px solid #333; margin-left:12px; }
  .status-item{ display:flex; justify-content:space-between; padding:6px; margin:6px 0; border-radius:6px; font-weight:bold; }
  .status-item.normal{ background:#003300; color:#00ff00; border:2px solid #00ff00; }
  .status-item.emergency{ background:#330000; color:#ff4444; border:2px solid #ff4444; animation: blink 1s infinite; }
  @keyframes blink{ 0%{ box-shadow:0 0 6px red } 50%{ box-shadow:0 0 18px red } 100%{ box-shadow:0 0 6px red } }
  .row{ display:flex; gap:12px; align-items:flex-start; margin-top:14px; flex-wrap:wrap; justify-content:center; }
</style>
</head>
<body>

<h2>ðŸ“Š Pie Chart</h2>

<div class="controls" id="sensorControls"></div>
<canvas id="sensorChart"></canvas>

<div class="row">
  <div id="statusPanel"></div>

  <div id="thresholdBox">
    <h3 style="margin:0 0 8px 0;">Threshold Values</h3>
  </div>
</div>

<script>
/* -----------------------
   CONFIG
----------------------- */
const apiURL = "https://script.google.com/macros/s/AKfycbyp2ozRqBGEdD6swM7I3xjeTkRgRWFW2VnHZ_Jn4nDw8KgRVYnqfYpOBsID4yPm3bZw/exec";

const sensors = ["TEMP","HUMDITY","WATER1","WATER2"];
let colors = ["#ff4444","#44aaff","#44ff44","#ffa500"];

let thresholds = { TEMP:35, HUMDITY:90, WATER1:40, WATER2:40 };
const saved = localStorage.getItem("sensorThresholds");
if(saved) thresholds = JSON.parse(saved);

let parsedData = [];
let chart = null;

/* -----------------------
   LOAD DATA
----------------------- */
function loadData(){
  fetch(apiURL)
    .then(r=>r.json())
    .then(sheet=>{

      parsedData = sheet.map(r => ({
        DATE: r.DATE,
        TIME: r.TIME,
        values: sensors.map(s => Number(r[s] ?? 0))
      }));

      const latest = parsedData[parsedData.length-1];
      const pieValues = latest.values;

      if(chart){
        chart.data.datasets[0].data = pieValues;
        chart.update();
      } else {
        const ctx = document.getElementById('sensorChart').getContext('2d');

        chart = new Chart(ctx,{
          type:'pie',
          data:{
            labels: sensors,
            datasets:[{
              data: pieValues,
              backgroundColor: colors,
            }]
          },
          options:{
            responsive:true,
            animation:{ duration:1200, easing:'easeOutQuart' },
            plugins:{
              legend:{
                labels:{ color:'#fff', font:{size:16, weight:'bold'} }
              },
              tooltip:{
                backgroundColor:'rgba(0,0,0,0.85)',
                titleFont:{ size:16, weight:'bold' },
                bodyFont:{ size:14 },
                padding:12,
                cornerRadius:10
              }
            }
          }
        });
      }

      updateStatus();
    })
}

/* -----------------------
   STATUS PANEL
----------------------- */
function updateStatus(){
  const panel=document.getElementById('statusPanel');
  panel.innerHTML='<h3>Status</h3>';

  sensors.forEach((s,i)=>{
    const latestValue = parsedData[parsedData.length-1].values[i];

    const div=document.createElement('div');
    div.className='status-item';

    if(latestValue > thresholds[s]){
      div.classList.add('emergency');
      div.innerHTML=`<span>${s}</span><span>ðŸš¨ ${latestValue}</span>`;
    } else {
      div.classList.add('normal');
      div.innerHTML=`<span>${s}</span><span>âœ” ${latestValue}</span>`;
    }
    panel.appendChild(div);
  });
}

/* -----------------------
   CONTROLS
----------------------- */
(function(){
  const control=document.getElementById('sensorControls');

  sensors.forEach((s,i)=>{
    const box=document.createElement('div');
    box.className='sensor-option';

    const lbl=document.createElement('label');
    lbl.textContent=s;

    const col=document.createElement('input');
    col.type='color';
    col.value=colors[i];
    col.oninput=()=>{ colors[i]=col.value; chart.data.datasets[0].backgroundColor=colors; chart.update(); };

    box.appendChild(lbl);
    box.appendChild(col);
    control.appendChild(box);
  });

  const box=document.getElementById('thresholdBox');
  sensors.forEach(s=>{
    const row=document.createElement('div');
    row.innerHTML=`<span>${s}</span>`;
    const input=document.createElement('input');
    input.type='number';
    input.value=thresholds[s];
    input.oninput=()=>{ thresholds[s]=Number(input.value); updateStatus(); };
    row.appendChild(input);
    box.appendChild(row);
  });

  const save=document.createElement('button');
  save.id='saveBtn';
  save.textContent='SAVE';
  save.onclick=()=>{ localStorage.setItem("sensorThresholds",JSON.stringify(thresholds)); alert("Saved!"); };
  box.appendChild(save);
})();

/* -----------------------
   AUTO REFRESH
----------------------- */
loadData();
setInterval(loadData,5000);

</script>
</body>
</html>
