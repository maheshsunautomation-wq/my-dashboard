<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cow Weight Dashboard - Latest Month</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
body {
  margin: 0;
  background: #000;
  font-family: 'Roboto', Arial, sans-serif;
  text-align: center;
  padding: 20px;
  color: #fff;
}

h2 { font-size: 2em; margin-bottom: 20px; letter-spacing: 1px; }

canvas {
  background: linear-gradient(180deg,#0b0b0b,#000);
  border-radius: 14px;
  box-shadow: inset 0 0 25px rgba(255,255,255,0.05),0 0 25px rgba(0,0,0,0.9);
  max-width: 96%; margin-bottom: 25px;
}

#statusPanel{display:flex; justify-content:center; flex-wrap:wrap; margin-top:20px;}
.status-item{margin:10px;padding:16px 22px;border-radius:12px;font-weight:600;min-width:150px;background:#0f0f0f;border-left:5px solid #666;box-shadow:0 0 15px rgba(0,0,0,0.8);}
.normal{border-color:#00ff5a;}
.alert{border-color:#ff1a1a;color:#ffb3b3;box-shadow:0 0 20px rgba(255,0,0,0.8);}
.blink{animation:neonBlink 1s infinite;}
@keyframes neonBlink{0%{box-shadow:0 0 5px #ff0000;}50%{box-shadow:0 0 25px #ff0000;}100%{box-shadow:0 0 5px #ff0000;}}
</style>
</head>
<body>

<h2>üêÑ Cow Weight Monitoring - Latest Month</h2>
<canvas id="cowChart"></canvas>
<div id="statusPanel"></div>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbxIzCALAAu3hqrsn3u9jXJCLtCWNwK8SZx6I1vLrYFw3HQpHVWGgCaT-YvH-keSsajQ/exec";

let chart;
let blinkOn = true;

// Helper to get year-month string
function getMonth(dateStr){
  const d = new Date(dateStr);
  return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}`;
}

async function loadData() {
  const res = await fetch(apiURL);
  const rows = await res.json();
  if(!rows.length) return;

  const cows = [...new Set(rows.map(r=>r.Cow))];

  const latestMonthData = {};
  const prevMonthData = {};

  // Process each cow
  cows.forEach(cow=>{
    const cowRows = rows.filter(r=>r.Cow===cow)
                        .sort((a,b)=>new Date(a.date)-new Date(b.date));
    
    // Get unique months sorted
    const months = [...new Set(cowRows.map(r=>getMonth(r.date)))].sort();
    if(months.length === 0) return;

    const latestMonth = months[months.length-1];
    const prevMonth = months.length > 1 ? months[months.length-2] : null;

    // Latest month weight = last entry in that month
    latestMonthData[cow] = cowRows.filter(r=>getMonth(r.date)===latestMonth).slice(-1)[0].weight;

    // Previous month weight
    prevMonthData[cow] = prevMonth ? cowRows.filter(r=>getMonth(r.date)===prevMonth).slice(-1)[0].weight : null;
  });

  const labels = cows;
  const datasets = [{
    label: 'Weight',
    data: labels.map(cow=>latestMonthData[cow]),
    originalColor: '#00ff5a', // green default
    backgroundColor: labels.map(cow=>{
      if(prevMonthData[cow] !== null && latestMonthData[cow] < prevMonthData[cow]){
        return '#ff0000';
      }
      return '#00ff5a';
    }),
    blinkIndexes: labels.map((cow,i)=>{
      return (prevMonthData[cow] !== null && latestMonthData[cow] < prevMonthData[cow]) ? i : -1;
    })
  }];

  if(!chart){
    chart = new Chart(cowChart,{
      type:'bar',
      data:{labels,datasets},
      options:{
        responsive:true,
        plugins:{
          legend:{display:false},
          datalabels:{color:'#fff',anchor:'end',align:'top',font:{weight:'600',size:12}},
          title:{display:true,text:'Cow Weight - Latest Month',color:'#fff',font:{size:18,weight:'600'}}
        },
        scales:{
          x:{ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.25)'}},
          y:{beginAtZero:true,ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.25)'}}
        }
      },
      plugins:[ChartDataLabels]
    });
  } else {
    chart.data.datasets = datasets.map(ds=>{
      ds.backgroundColor = ds.data.map((_,idx)=>ds.blinkIndexes.includes(idx) && ds.blinkIndexes[idx]!==-1 ? (blinkOn?'#ff0000':ds.originalColor) : ds.originalColor);
      return ds;
    });
    chart.update();
  }

  // Status Panel
  const statusPanel=document.getElementById('statusPanel');
  statusPanel.innerHTML='';
  labels.forEach((cow,i)=>{
    const isDrop = prevMonthData[cow] !== null && latestMonthData[cow] < prevMonthData[cow];
    const div=document.createElement('div');
    div.className='status-item '+(isDrop?'alert blink':'normal');
    div.textContent=`${cow}: Last Month Drop ${isDrop?'YES':'NO'}`;
    statusPanel.appendChild(div);
  });
}

// Blink toggle
setInterval(()=>{
  blinkOn = !blinkOn;
  if(chart){
    chart.data.datasets.forEach(ds=>{
      ds.backgroundColor = ds.data.map((_,idx)=>ds.blinkIndexes.includes(idx) && ds.blinkIndexes[idx]!==-1 ? (blinkOn?'#ff0000':ds.originalColor) : ds.originalColor);
    });
    chart.update();
  }
},500);

loadData();
setInterval(loadData,10000);
</script>
</body>
</html>
