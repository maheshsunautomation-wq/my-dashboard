<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cow Weight Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
body {
  margin: 0;
  background: #000;
  font-family: 'Roboto', Arial, sans-serif;
  text-align: center;
  padding: 20px;
  color: #fff;
}

h2 { font-size: 2em; margin-bottom: 20px; letter-spacing: 1px; }

canvas {
  background: linear-gradient(180deg,#0b0b0b,#000);
  border-radius: 14px;
  box-shadow: inset 0 0 25px rgba(255,255,255,0.05),0 0 25px rgba(0,0,0,0.9);
  max-width: 96%; margin-bottom: 25px;
}

#colorPanel { margin-bottom:18px; display:flex; justify-content:center; flex-wrap:wrap;}
#colorPanel label { margin:0 12px; font-weight:600; display:flex; align-items:center; gap:6px; }
input[type=color]{width:34px;height:22px;border:none;cursor:pointer;border-radius:5px;}

#statusPanel{display:flex; justify-content:center; flex-wrap:wrap; margin-top:20px;}
.status-item{margin:10px;padding:16px 22px;border-radius:12px;font-weight:600;min-width:150px;background:#0f0f0f;border-left:5px solid #666;box-shadow:0 0 15px rgba(0,0,0,0.8);}
.normal{border-color:#00ff5a;}
.alert{border-color:#ff1a1a;color:#ffb3b3;box-shadow:0 0 20px rgba(255,0,0,0.8);}
.blink{animation:neonBlink 1s infinite;}
@keyframes neonBlink{0%{box-shadow:0 0 5px #ff0000;}50%{box-shadow:0 0 25px #ff0000;}100%{box-shadow:0 0 5px #ff0000;}}
</style>
</head>
<body>

<h2>üêÑ Cow Weight Monitoring</h2>
<div id="colorPanel"></div>
<canvas id="cowChart"></canvas>
<div id="statusPanel"></div>

<script>
const apiURL = "https://script.google.com/macros/s/AKfycbxIzCALAAu3hqrsn3u9jXJCLtCWNwK8SZx6I1vLrYFw3HQpHVWGgCaT-YvH-keSsajQ/exec";

let chart;
let cowColors = {};
let blinkOn = true;

async function loadData() {
  const res = await fetch(apiURL);
  const rows = await res.json();
  if(!rows.length) return;

  const cows = [...new Set(rows.map(r=>r.Cow))];
  const colorPanel = document.getElementById("colorPanel");

  /* Color Picker */
  if(Object.keys(cowColors).length===0){
    const preset=['#00ff00','#ffff00','#00c8ff','#ff00ff'];
    colorPanel.innerHTML='';
    cows.forEach((cow,i)=>{
      cowColors[cow]=preset[i%preset.length];
      const input=document.createElement('input');
      input.type='color';
      input.value=cowColors[cow];
      input.oninput=()=>{ cowColors[cow]=input.value; updateChartColors(); };
      const label=document.createElement('label');
      label.textContent=cow;
      label.appendChild(input);
      colorPanel.appendChild(label);
    });
  }

  const labels = rows.map(r => r.date);

  const datasets = cows.map(cow => {
    // Filter rows for this cow and sort by date
    const cowRows = rows.filter(r => r.Cow === cow)
                        .sort((a,b) => new Date(a.date) - new Date(b.date));

    const blinkIndexes = [];
    const data = rows.map((r, idx) => {
      if(r.Cow !== cow) return null;

      const todayIndex = cowRows.length - 1; // latest date for this cow
      const todayWeight = cowRows[todayIndex].weight;
      const prevWeight = todayIndex > 0 ? cowRows[todayIndex-1].weight : null;

      if(prevWeight !== null && r.date === cowRows[todayIndex].date && todayWeight < prevWeight){
        blinkIndexes.push(idx);
      }

      return r.weight;
    });

    return {
      label: cow,
      data: data,
      originalColor: cowColors[cow],
      backgroundColor: data.map((_,idx)=>blinkIndexes.includes(idx)?'#ff0000':cowColors[cow]),
      borderRadius:4,barThickness:22,borderWidth:0,blinkIndexes
    };
  });

  if(!chart){
    chart=new Chart(cowChart,{
      type:'bar',
      data:{labels,datasets},
      options:{
        responsive:true,
        plugins:{
          legend:{labels:{color:'#fff',font:{weight:'600'}}},
          datalabels:{color:'#fff',anchor:'end',align:'top',font:{weight:'600',size:10}},
          title:{display:true,text:'Cow Weight Monitoring',color:'#fff',font:{size:18,weight:'600'}}
        },
        scales:{
          x:{ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.25)'}},
          y:{beginAtZero:true,ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.25)'}}
        }
      },
      plugins:[ChartDataLabels]
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets = datasets.map(ds=>{
      ds.backgroundColor=ds.data.map((_,idx)=>ds.blinkIndexes.includes(idx)?(blinkOn?'#ff0000':ds.originalColor):ds.originalColor);
      return ds;
    });
    chart.update();
  }

  /* Status Panel */
  const statusPanel=document.getElementById('statusPanel');
  statusPanel.innerHTML='';
  cows.forEach(cow=>{
    const dropCount=datasets.find(d=>d.label===cow).blinkIndexes.length;
    const div=document.createElement('div');
    div.className='status-item '+(dropCount>0?'alert blink':'normal');
    div.textContent=`${cow}: Latest Drop ${dropCount>0?'YES':'NO'}`;
    statusPanel.appendChild(div);
  });
}

/* Blink toggle */
setInterval(()=>{
  blinkOn = !blinkOn;
  if(chart){
    chart.data.datasets.forEach(ds=>{
      ds.backgroundColor = ds.data.map((_,idx)=>ds.blinkIndexes.includes(idx)?(blinkOn?'#ff0000':ds.originalColor):ds.originalColor);
    });
    chart.update();
  }
},500);

function updateChartColors(){ chart.data.datasets.forEach(ds=>{ds.originalColor=cowColors[ds.label];}); chart.update(); }

loadData();
setInterval(loadData,5000);
</script>
</body>
</html>
