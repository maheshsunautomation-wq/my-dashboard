<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cow Weight Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Roboto,Arial,sans-serif;
  text-align:center;
  padding:20px;
}
h2{margin-bottom:20px}
canvas{
  background:linear-gradient(180deg,#0b0b0b,#000);
  border-radius:14px;
  max-width:96%;
}
#colorPanel{display:flex;justify-content:center;flex-wrap:wrap;margin-bottom:15px}
#colorPanel label{margin:0 10px;font-weight:600;display:flex;align-items:center;gap:6px}
input[type=color]{width:30px;height:20px;border:none;border-radius:5px}
#statusPanel{display:flex;justify-content:center;flex-wrap:wrap;margin-top:20px}
.status-item{padding:14px 20px;margin:8px;border-radius:12px;background:#111;border-left:5px solid #666}
.normal{border-color:#00ff5a}
.alert{border-color:#ff1a1a;color:#ffb3b3}
.blink{animation:blink 1s infinite}
@keyframes blink{50%{box-shadow:0 0 18px #ff0000}}
</style>
</head>

<body>

<h2>üêÑ Cow Weight Monitoring</h2>
<div id="colorPanel"></div>
<canvas id="cowChart"></canvas>
<div id="statusPanel"></div>

<script>
const apiURL="https://script.google.com/macros/s/AKfycbxIzCALAAu3hqrsn3u9jXJCLtCWNwK8SZx6I1vLrYFw3HQpHVWGgCaT-YvH-keSsajQ/exec";

let chart, cowColors={}, blinkOn=true;

async function loadData(){
  const res=await fetch(apiURL);
  const rows=await res.json();
  if(!rows.length) return;

  const cows=[...new Set(rows.map(r=>r.Cow))];
  const labels=[...new Set(rows.map(r=>r.date))];

  if(Object.keys(cowColors).length===0){
    const preset=['#00ff5a','#00c8ff','#ff00ff','#ffff00'];
    const panel=document.getElementById('colorPanel');
    cows.forEach((c,i)=>{
      cowColors[c]=preset[i%preset.length];
      const inp=document.createElement('input');
      inp.type='color'; inp.value=cowColors[c];
      inp.oninput=()=>cowColors[c]=inp.value;
      const lbl=document.createElement('label');
      lbl.textContent=c; lbl.appendChild(inp);
      panel.appendChild(lbl);
    });
  }

  const datasets=cows.map(cow=>{
    const cowRows=rows.filter(r=>r.Cow===cow)
                      .sort((a,b)=>new Date(a.date)-new Date(b.date));
    const last=cowRows.length-1;
    const drop=last>0 && cowRows[last].weight<cowRows[last-1].weight;
    const blinkDate=drop?cowRows[last].date:null;

    return{
      label:cow,
      data:labels.map(d=>{
        const r=cowRows.find(x=>x.date===d);
        return r?r.weight:null;
      }),
      borderColor:cowColors[cow],
      borderWidth:3,
      tension:0.35,
      spanGaps:false,
      pointRadius:labels.map(d=>d===blinkDate?(blinkOn?9:5):5),
      pointHitRadius:15,
      pointHoverRadius:12,
      pointHoverBorderWidth:3,
      pointHoverBorderColor:'#ffffff',
      pointBackgroundColor:labels.map(d=>d===blinkDate?'#ff0000':cowColors[cow]),
      blink:drop
    };
  });

  if(!chart){
    chart=new Chart(cowChart,{
      type:'line',
      data:{labels,datasets},
      options:{
        responsive:true,

        /* üî• THIS FIXES RANDOM BEHAVIOR */
        interaction:{
          mode:'nearest',
          intersect:false
        },

        plugins:{
          legend:{labels:{color:'#fff'}},
          datalabels:{display:false},
          tooltip:{
            enabled:true,
            backgroundColor:'#111',
            borderColor:'#00ff5a',
            borderWidth:1,
            titleColor:'#00ff5a',
            bodyColor:'#fff',
            callbacks:{
              title:(c)=>`Date: ${c[0].label}`,
              label:(c)=>`${c.dataset.label} ‚Üí ${c.parsed.y} kg`
            }
          }
        },
        scales:{
          x:{ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.15)'}},
          y:{ticks:{color:'#fff'},grid:{color:'rgba(255,255,255,0.15)'}}
        }
      }
    });
  }else{
    chart.data.labels=labels;
    chart.data.datasets=datasets;
    chart.update();
  }

  const panel=document.getElementById('statusPanel');
  panel.innerHTML='';
  datasets.forEach(d=>{
    const div=document.createElement('div');
    div.className='status-item '+(d.blink?'alert blink':'normal');
    div.textContent=`${d.label}: Latest Drop ${d.blink?'YES':'NO'}`;
    panel.appendChild(div);
  });
}

setInterval(()=>{
  blinkOn=!blinkOn;
  if(chart) chart.update();
},500);

loadData();
setInterval(loadData,5000);
</script>
</body>
</html>
